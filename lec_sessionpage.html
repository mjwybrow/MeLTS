<!DOCTYPE html>

<!--Written by Shea Yuin Ng-->
<!--Created 3 October 2012-->
<!--This is the page that lecturer post question-->

<html>
<head>
	<script src="http://118.138.154.21:8000/socket.io/socket.io.js"></script>
	<link rel="stylesheet" href="jquery.mobile-1.1.1.min.css" /> 
	<script type="text/javascript" src="jquery-1.8.0.min.js"></script>
	<script type="text/javascript" src="jquery.mobile-1.1.1.min.js"></script>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<script type="text/javascript">
		function end_session(){
			$.get("end_session.php", function(data){
			//$.get("http://syngtest.myproject/end_session.php", function(data){
				window.location.href = "lec_ques_list.html";
			});
		};

		$.post("username.php", function(data){
		//$.post("http://syngtest.myproject/username.php", function(data){

			var name = data;
			var socket = io.connect('http://118.138.154.21:8000');
			 
			// at document read (runs only once).
			$(document).ready(function(){
				
				//use jquery ajax to post data to php server
				$.ajax({
					//url: "http://syngtest.myproject/lec_question.php",
					url: "lec_post_ques.php",
					type: 'post',
					dataType: "xml",  
					success: function (xml) {
					//results sent by PHP	
					
						// Read xml file
						$(xml).find('Ques').each(function(){ 
							var unit_code = $(this).find('UnitCode').text(); 	
							var id = $(this).find('ID').text(); 	
							var lec_ques = $(this).find('Question').text(); 
							var A = $(this).find('A').text();
							var B = $(this).find('B').text(); 	
							var C = $(this).find('C').text(); 	
							var D = $(this).find('D').text(); 	
							
							if (lec_ques== "0"){// means there's no question posted by lecturer
								// Empty list, show this msg
								$("p#log").text('No question posted!!');
							}
							else{// list the units in an unordered list
								// send message on inputbox to server
								socket.emit('ques', { 
									unit_code: unit_code,
									id: id,
									ques: lec_ques,
									A: A,
									B: B,
									C: C,
									D: D,
									
								});
								
								$('#lec_ques').html(lec_ques);
								$('#A').html(A);
								$('#B').html(B);
								$('#C').html(C);
								$('#D').html(D);
								
								//$('#resulta').html('0 out of 0');
								//$('#resultb').html('0 out of 0');
								//$('#resultc').html('0 out of 0');
								///$('#resultd').html('0 out of 0');
								//$("p#log").html('Question posted');
							} 
						})
						
						
					},
					error: function(){	
					alert('There was an error posting lecturers question');	
					}
					
				});
			
				// Updated answers from students
				socket.on('updated', function (data) {
					console.log('Answer: ', data.mcq_answer);
					var lec_ques = data.lec_ques;
					var mcq_answer = data.mcq_answer;
					
					$.ajax({
						//url: "http://syngtest.myproject/getstu_answers.php",
						url: "getstu_answers.php",
						type: 'post',
						dataType: "xml",  
						success: function (xml) {
				
							//results sent by PHP
							cntA = xml.getElementsByTagName("CntA")[0].childNodes[0].nodeValue;
							cntB = xml.getElementsByTagName("CntB")[0].childNodes[0].nodeValue;
							cntC = xml.getElementsByTagName("CntC")[0].childNodes[0].nodeValue;
							cntD = xml.getElementsByTagName("CntD")[0].childNodes[0].nodeValue;
							total = xml.getElementsByTagName("Total")[0].childNodes[0].nodeValue;
							//$(xml).find('Answer').each(function(){  
							//var cntA = $(this).find('CntA').text(); 
							//var cntB = $(this).find('CntB').text(); 
							//var cntC = $(this).find('CntC').text(); 
							//var cntD = $(this).find('CntD').text(); 
							//var total = $(this).find('Total').text(); 
						
							//});
							// Display data
							
							$('#resulta').html(cntA+' out of '+total);
							$('#resultb').html(cntB+' out of '+total);
							$('#resultc').html(cntC+' out of '+total);
							$('#resultd').html(cntD+' out of '+total);
						},
						error: function(){	
							console.log('There was an error in student answering question');	
						}
					});		
				});			
			
				
				// ask user to log in again if no username available.
				while (name == '') {
				   name = alert("Please log in!");
				   window.location.href = "index.html";
				   //$.mobile.changePage($(document.location.href="index.html"), "slideup");
				};
				
				// send the name to the server, and the server's 
				// register wait will recieve this.
				socket.emit('register', name );
			});
			 
			 // listen for chat event and recieve data
			 //socket.on('ques', function (data) {
			 
				// print data (jquery thing)
			   // $("p#data_received").append("<br />\r\n" + data.ques + ': A.' + data.A+ '     B.'+ data.B+'     C.'+ data.C+'     D.'+ data.D);
	  
				
			 //});
			 
		});
	</script>
</head>

<body>
	<!-- Lecturer sessionpage -->
	<div data-role="page" id="lec_sessionpage">
		
		<div data-role="header">
			<h1>Post a question</h1>
		</div><!-- /header -->
		
		<div data-role="content">

			<div>
				<label for="unit_code">Question</label>
				<p id="lec_ques" ></p>
			</div>
			
			<div>
				<label for="unit_name">A</label><p id='resulta'></p>
				<p id="A" ></p>
				<p id="resulta" >0 out of 0</p>
			</div>
			<div>
				<label for="unit_name">B</label><p id='resultb'></p>
				<p id="B" ></p>
				<p id="resultb" >0 out of 0</p>
			</div>
			<div>
				<label for="unit_name">C</label><p id='resultc'></p>
				<p id="C" ></p>
				<p id="resultc" >0 out of 0</p>
			</div>
			<div>
				<label for="unit_name">D</label><p id='resultd'></p>
				<p id="D" ></p>
				<p id="resultd" >0 out of 0</p>
			</div>
			
			<p id='log'>
			</p>
			<p id='data_received'>
			</p>
			
			<!-- Buttons to direct to other functions -->
			<div>
				<button onclick="end_session();" data-theme="e" data-role="button" data-mini = "true" id="end_session">End Question</button>
			</div>

			
			<!-- Buttons to direct to other functions -->
			<div data-role="controlgroup">
				<br>
				<a href="index.html" data-role="button">View student's question</a>
				<a href="index.html" data-role="button">U-scale</a>
			</div>
			
			
		</div><!-- /content -->

	</div><!-- /page --> 
	
</body>
</html>
